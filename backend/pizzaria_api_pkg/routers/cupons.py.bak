from pizzaria_api_pkg.services.cupons_service import aplicar_cupom
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from pizzaria_api_pkg.database import get_db
from pizzaria_api_pkg.core_models import Cupom
from pizzaria_api_pkg.schemas import CupomCreate, CupomResponse
from pizzaria_api_pkg.schemas.cupons import *

router = APIRouter(prefix="/cupons", tags=["Cupons"])

@router.get("/", response_model=list[CupomResponse])
def listar_cupons(db: Session = Depends(get_db)):
    return db.query(Cupom).filter(Cupom.ativo == True).all()

@router.post("/", response_model=CupomResponse)
def criar_cupom(cupom: CupomCreate, db: Session = Depends(get_db)):
    novo_cupom = Cupom(**cupom.dict())
    db.add(novo_cupom)
    db.commit()
    db.refresh(novo_cupom)
    return novo_cupom

@router.delete("/{cupom_id}")
def desativar_cupom(cupom_id: int, db: Session = Depends(get_db)):
    cupom = db.query(Cupom).get(cupom_id)
    if not cupom:
        raise HTTPException(status_code=404, detail="Cupom n√£o encontrado")
    cupom.ativo = False
    db.commit()
    return {"mensagem": "Cupom desativado"}
